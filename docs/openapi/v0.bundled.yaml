openapi: 3.1.0
info:
  title: Plataforma GALA API
  version: 0.1.0
  description: |
    Plataforma GALA (Generación Audiovisual Local con Avatares). Contrato API v0 (local, sin auth).
servers:
  - url: http://localhost:8080
    description: Local
tags:
  - name: Health
  - name: Assets
  - name: Models
  - name: Templates
  - name: Jobs
paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      operationId: health
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  version:
                    type: string
                required:
                  - status
                  - service
                  - version
  /assets:
    post:
      tags:
        - Assets
      summary: Upload asset (multipart)
      operationId: uploadAsset
      description: |
        Upload de un asset. La API lo recibe, lo sube al storage provider (ej. Google Drive) y registra el asset en DB.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                kind:
                  $ref: '#/components/schemas/AssetKind'
                label:
                  type: string
                  description: Etiqueta opcional para facilitar búsqueda/uso.
              required:
                - file
                - kind
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '500':
          $ref: '#/components/responses/InternalError'
    get:
      tags:
        - Assets
      summary: List assets
      operationId: listAssets
      parameters:
        - in: query
          name: kind
          schema:
            $ref: '#/components/schemas/AssetKind'
        - in: query
          name: q
          schema:
            type: string
          description: Búsqueda libre (label, etc.)
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetsListResponse'
        '500':
          $ref: '#/components/responses/InternalError'
    assetById:
      get:
        tags:
          - Assets
        summary: Get asset metadata
        operationId: getAsset
        parameters:
          - $ref: '#/components/parameters/assetId'
        responses:
          '200':
            description: OK
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/AssetResponse'
          '404':
            $ref: '#/components/responses/NotFound'
          '500':
            $ref: '#/components/responses/InternalError'
      delete:
        tags:
          - Assets
        summary: Delete asset
        operationId: deleteAsset
        description: |
          v0: Elimina el registro del asset (comportamiento exacto definido por implementación). En v0 no garantiza borrar el archivo del provider.
        parameters:
          - $ref: '#/components/parameters/assetId'
        responses:
          '204':
            description: Deleted
          '404':
            $ref: '#/components/responses/NotFound'
          '409':
            $ref: '#/components/responses/Conflict'
          '500':
            $ref: '#/components/responses/InternalError'
    assetURL:
      get:
        tags:
          - Assets
        summary: Get asset download URL (v0)
        operationId: getAssetURL
        description: |
          v0: Puede devolver una URL de proxy local o un signed URL dependiendo del provider.
        parameters:
          - $ref: '#/components/parameters/assetId'
        responses:
          '200':
            description: OK
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/AssetURLResponse'
          '404':
            $ref: '#/components/responses/NotFound'
          '500':
            $ref: '#/components/responses/InternalError'
    assetContent:
      get:
        tags:
          - Assets
        summary: Stream asset binary content
        operationId: streamAssetContent
        parameters:
          - $ref: '#/components/parameters/assetId'
        responses:
          '200':
            description: Binary stream
            content:
              application/octet-stream:
                schema:
                  type: string
                  format: binary
          '404':
            $ref: '#/components/responses/NotFound'
          '500':
            $ref: '#/components/responses/InternalError'
  /assets/{assetId}:
    get:
      tags:
        - Assets
      summary: Get asset metadata
      operationId: getAsset
      parameters:
        - $ref: '#/components/parameters/assetId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Assets
      summary: Delete asset
      operationId: deleteAsset
      description: |
        v0: Elimina el registro del asset (comportamiento exacto definido por implementación). En v0 no garantiza borrar el archivo del provider.
      parameters:
        - $ref: '#/components/parameters/assetId'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'
  /assets/{assetId}/url:
    get:
      tags:
        - Assets
      summary: Get asset download URL (v0)
      operationId: getAssetURL
      description: |
        v0: Puede devolver una URL de proxy local o un signed URL dependiendo del provider.
      parameters:
        - $ref: '#/components/parameters/assetId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetURLResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
  /assets/{assetId}/content:
    get:
      tags:
        - Assets
      summary: Stream asset binary content
      operationId: streamAssetContent
      parameters:
        - $ref: '#/components/parameters/assetId'
      responses:
        '200':
          description: Binary stream
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
  /templates:
    post:
      tags:
        - Templates
      summary: Create template
      operationId: createTemplate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
      responses:
        '201':
          description: Template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'
    get:
      tags:
        - Templates
      summary: List templates
      operationId: listTemplates
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplatesListResponse'
        '500':
          $ref: '#/components/responses/InternalError'
    templateById:
      get:
        tags:
          - Templates
        summary: Get template
        operationId: getTemplate
        parameters:
          - $ref: '#/components/parameters/templateId'
        responses:
          '200':
            description: OK
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/TemplateResponse'
          '404':
            $ref: '#/components/responses/NotFound'
          '500':
            $ref: '#/components/responses/InternalError'
      patch:
        tags:
          - Templates
        summary: Update template
        operationId: updateTemplate
        parameters:
          - $ref: '#/components/parameters/templateId'
        requestBody:
          required: true
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateTemplateRequest'
        responses:
          '200':
            description: Updated
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/TemplateResponse'
          '400':
            $ref: '#/components/responses/ValidationError'
          '404':
            $ref: '#/components/responses/NotFound'
          '409':
            $ref: '#/components/responses/Conflict'
          '500':
            $ref: '#/components/responses/InternalError'
      delete:
        tags:
          - Templates
        summary: Delete template
        operationId: deleteTemplate
        parameters:
          - $ref: '#/components/parameters/templateId'
        responses:
          '204':
            description: Deleted
          '404':
            $ref: '#/components/responses/NotFound'
          '500':
            $ref: '#/components/responses/InternalError'
  /templates/{templateId}:
    get:
      tags:
        - Templates
      summary: Get template
      operationId: getTemplate
      parameters:
        - $ref: '#/components/parameters/templateId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    patch:
      tags:
        - Templates
      summary: Update template
      operationId: updateTemplate
      parameters:
        - $ref: '#/components/parameters/templateId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTemplateRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Templates
      summary: Delete template
      operationId: deleteTemplate
      parameters:
        - $ref: '#/components/parameters/templateId'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
  /models:
    post:
      tags:
        - Models
      summary: Create model (avatar profile)
      operationId: createModel
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateModelRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'
    get:
      tags:
        - Models
      summary: List models
      operationId: listModels
      parameters:
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: tag
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsListResponse'
        '500':
          $ref: '#/components/responses/InternalError'
  /models/{modelId}:
    get:
      tags:
        - Models
      summary: Get model
      operationId: getModel
      parameters:
        - $ref: '#/components/parameters/modelId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    patch:
      tags:
        - Models
      summary: Update model (partial)
      operationId: updateModel
      parameters:
        - $ref: '#/components/parameters/modelId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateModelRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Models
      summary: Delete model
      operationId: deleteModel
      parameters:
        - $ref: '#/components/parameters/modelId'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'
  /jobs:
    post:
      tags:
        - Jobs
      summary: Create render job (batch)
      operationId: createJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'
    get:
      tags:
        - Jobs
      summary: List jobs
      operationId: listJobs
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum:
              - QUEUED
              - RUNNING
              - DONE
              - FAILED
        - in: query
          name: template_id
          schema:
            type: string
        - in: query
          name: model_id
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobsListResponse'
        '500':
          $ref: '#/components/responses/InternalError'
  /jobs/{jobId}:
    get:
      tags:
        - Jobs
      summary: Get job details (including outputs if DONE)
      operationId: getJob
      parameters:
        - $ref: '#/components/parameters/jobId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobDetailResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
components:
  parameters:
    assetId:
      name: assetId
      in: path
      required: true
      schema:
        type: string
    templateId:
      name: templateId
      in: path
      required: true
      schema:
        type: string
    modelId:
      name: modelId
      in: path
      required: true
      schema:
        type: string
    jobId:
      name: jobId
      in: path
      required: true
      schema:
        type: string
  responses:
    InternalError:
      description: Internal error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    PayloadTooLarge:
      description: Payload too large
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
  schemas:
    AssetKind:
      type: string
      enum:
        - source_video
        - avatar_input
        - music
        - render_output
        - thumbnail
        - overlay
        - background
        - other
    Asset:
      type: object
      properties:
        id:
          type: string
        kind:
          $ref: '#/components/schemas/AssetKind'
        provider:
          type: string
        object_key:
          type: string
          description: Provider object key (Google Drive fileId for gdrive)
        mime:
          type: string
        size_bytes:
          type: integer
        checksum:
          type: string
          nullable: true
        label:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
      required:
        - id
        - kind
        - provider
        - object_key
        - mime
        - size_bytes
        - created_at
    AssetsListResponse:
      type: object
      properties:
        assets:
          type: array
          items:
            $ref: '#/components/schemas/Asset'
      required:
        - assets
    ErrorEnvelope:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true
          required:
            - code
            - message
      required:
        - error
    AssetResponse:
      type: object
      properties:
        asset:
          $ref: '#/components/schemas/Asset'
      required:
        - asset
    AssetURLResponse:
      type: object
      properties:
        asset_id:
          type: string
        url:
          type: string
        expires_at:
          type: string
          format: date-time
          nullable: true
      required:
        - asset_id
        - url
    TemplateFormat:
      type: object
      properties:
        width:
          type: integer
        height:
          type: integer
        fps:
          type: integer
      required:
        - width
        - height
        - fps
    Template:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        name:
          type: string
        duration_ms:
          type: integer
          nullable: true
        format:
          $ref: '#/components/schemas/TemplateFormat'
        params_schema:
          type: object
          additionalProperties: true
        defaults:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
      required:
        - id
        - type
        - name
        - created_at
    TemplatesListResponse:
      type: object
      properties:
        templates:
          type: array
          items:
            $ref: '#/components/schemas/Template'
      required:
        - templates
    CreateTemplateRequest:
      type: object
      required:
        - type
        - name
      properties:
        type:
          type: string
        name:
          type: string
        duration_ms:
          type: integer
          nullable: true
        format:
          $ref: '#/components/schemas/TemplateFormat'
        params_schema:
          type: object
          additionalProperties: true
        defaults:
          type: object
          additionalProperties: true
    TemplateResponse:
      type: object
      properties:
        template:
          $ref: '#/components/schemas/Template'
      required:
        - template
    UpdateTemplateRequest:
      type: object
      properties:
        type:
          type: string
        name:
          type: string
        duration_ms:
          type: integer
          nullable: true
        format:
          $ref: '#/components/schemas/TemplateFormat'
        params_schema:
          type: object
          additionalProperties: true
        defaults:
          type: object
          additionalProperties: true
    Model:
      type: object
      properties:
        id:
          type: string
        stage_name:
          type: string
        tags:
          type: array
          items:
            type: string
        preset:
          type: object
          additionalProperties: true
        asset_ids:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
      required:
        - id
        - stage_name
        - created_at
    ModelsListResponse:
      type: object
      properties:
        models:
          type: array
          items:
            $ref: '#/components/schemas/Model'
      required:
        - models
    CreateModelRequest:
      type: object
      properties:
        stage_name:
          type: string
        tags:
          type: array
          items:
            type: string
        preset:
          type: object
          additionalProperties: true
        asset_ids:
          type: array
          items:
            type: string
      required:
        - stage_name
    ModelResponse:
      type: object
      properties:
        model:
          $ref: '#/components/schemas/Model'
      required:
        - model
    UpdateModelRequest:
      type: object
      properties:
        stage_name:
          type: string
        tags:
          type: array
          items:
            type: string
        preset:
          type: object
          additionalProperties: true
        asset_ids:
          type: array
          items:
            type: string
    Job:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          nullable: true
        status:
          type: string
          enum:
            - QUEUED
            - RUNNING
            - DONE
            - FAILED
        template_id:
          type: string
        model_ids:
          type: array
          items:
            type: string
        params:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        finished_at:
          type: string
          format: date-time
          nullable: true
      required:
        - id
        - status
        - created_at
    JobsListResponse:
      type: object
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/Job'
      required:
        - jobs
    CreateJobRequest:
      type: object
      required:
        - template_id
        - model_ids
      properties:
        name:
          type: string
        template_id:
          type: string
        model_ids:
          type: array
          items:
            type: string
        inputs:
          type: object
          additionalProperties: true
        params:
          type: object
          additionalProperties: true
        output:
          type: object
          additionalProperties: true
    JobResponse:
      type: object
      properties:
        job:
          $ref: '#/components/schemas/Job'
      required:
        - job
    JobOutput:
      type: object
      properties:
        variant:
          type: integer
        video_asset_id:
          type: string
        thumbnail_asset_id:
          type: string
      required:
        - variant
        - video_asset_id
    JobDetail:
      allOf:
        - $ref: '#/components/schemas/Job'
        - type: object
          properties:
            outputs:
              type: array
              items:
                $ref: '#/components/schemas/JobOutput'
    JobDetailResponse:
      type: object
      properties:
        job:
          $ref: '#/components/schemas/JobDetail'
      required:
        - job
